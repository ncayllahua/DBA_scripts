<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb" lang="en-gb" >

<head>
  <base href="http://blogdemo.remedios.local/index.php/oracle-adatbazis-adminisztracio/47-sql-hangolas-plan-management-tel" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="keywords" content="Oracle" />
  <meta name="robots" content="noindex, follow" />
  <meta name="author" content="KoltaiR" />
  <meta name="description" content="Oracle" />
  <meta name="generator" content="Joomla! - Open Source Content Management" />
  <title>SQL hangolás Plan Management-tel</title>
  <link href="http://blogdemo.remedios.local/index.php/component/search/?Itemid=104&amp;catid=10&amp;id=47&amp;format=opensearch" rel="search" title="Search oracleblog.remedios.hu" type="application/opensearchdescription+xml" />
  <link rel="stylesheet" href="/plugins/content/hs_highlighter/lib/styles/shCore.css" type="text/css" />
  <link rel="stylesheet" href="/plugins/content/hs_highlighter/lib/styles/shThemeDefault.css" type="text/css" />
  <script src="/media/system/js/mootools-core.js" type="text/javascript"></script>
  <script src="/media/system/js/core.js" type="text/javascript"></script>
  <script src="/media/system/js/caption.js" type="text/javascript"></script>
  <script src="/media/system/js/mootools-more.js" type="text/javascript"></script>
  <script src="/plugins/content/hs_highlighter/lib/scripts/shCore.js" type="text/javascript"></script>
  <script src="/plugins/content/hs_highlighter/lib/scripts/shAutoloader.js" type="text/javascript"></script>
  <script type="text/javascript">
window.addEvent('load', function() {
				new JCaption('img.caption');
			});window.addEvent('load',function(){
	var siteurl = 'http://blogdemo.remedios.local/';
	function path(){
	  var args = arguments,result = [];
	  for(var i = 0; i < args.length; i++){
	  	result.push(args[i].replace('@', [siteurl,'plugins/content/hs_highlighter/lib/scripts/'].join('')));
	  }
	  return result;
	};
	 
	SyntaxHighlighter.autoloader.apply(null, path(
	  'applescript            @shBrushAppleScript.js',
	  'actionscript3 as3      @shBrushAS3.js',
	  'bash shell             @shBrushBash.js',
	  'coldfusion cf          @shBrushColdFusion.js',
	  'cpp c                  @shBrushCpp.js',
	  'c# c-sharp csharp      @shBrushCSharp.js',
	  'css                    @shBrushCss.js',
	  'delphi pascal          @shBrushDelphi.js',
	  'diff patch pas         @shBrushDiff.js',
	  'erl erlang             @shBrushErlang.js',
	  'groovy                 @shBrushGroovy.js',
	  'java                   @shBrushJava.js',
	  'jfx javafx             @shBrushJavaFX.js',
	  'js jscript javascript  @shBrushJScript.js',
	  'perl pl                @shBrushPerl.js',
	  'php                    @shBrushPhp.js',
	  'text plain             @shBrushPlain.js',
	  'py python              @shBrushPython.js',
	  'ruby rails ror rb      @shBrushRuby.js',
	  'sass scss              @shBrushSass.js',
	  'scala                  @shBrushScala.js',
	  'sql                    @shBrushSql.js',
	  'vb vbnet               @shBrushVb.js',
	  'xml xhtml xslt html    @shBrushXml.js'
	  
	));
	
	;
	SyntaxHighlighter.all();	
});
		
		
  </script>

<link rel="stylesheet" href="/templates/system/css/system.css" type="text/css" />
<link rel="stylesheet" href="/templates/system/css/general.css" type="text/css" />
<link rel="stylesheet" href="/templates/a4joomla-lakeside-free/css/template.css" type="text/css" />
<link rel="stylesheet" href="/templates/a4joomla-lakeside-free/css/grey.css" type="text/css" />
<!--[if IE 6]>
<link rel="stylesheet" href="/templates/a4joomla-lakeside-free/css/ie6.css" type="text/css" />
<style type="text/css">
img, div, a, input { behavior: url(/templates/a4joomla-lakeside-free/iepngfix.htc) }
#search input.inputbox { behavior:none;}
</style>
<script src="/templates/a4joomla-lakeside-free/js/iepngfix_tilebg.js" type="text/javascript"></script>
<![endif]-->
<!--[if lte IE 7]>
<link rel="stylesheet" href="/templates/a4joomla-lakeside-free/css/ie67.css" type="text/css" />
<![endif]-->
<!--[if lte IE 8]>
<style type="text/css">
#search input.inputbox { behavior: url(/templates/a4joomla-lakeside-free/js/PIE.php) }
</style>
<![endif]-->
<style type="text/css">
 #logo {
    width:300px;
 }
 #headerright {
    width:734px;
	       background: none;   
     } 
 #search {
   width:170px;
   height:32px;
 }
 #slideshow-container {
	width:1054px;
	height:350px;
 }
 #slideshow-container img { 
	width:954px; 
	height:350px;
 }
 #slcontrol {
	width:954px; 
	top:42.857142857143%;
 }
 a#slprev {
    background: url("/templates/a4joomla-lakeside-free/images/previous-white.png") no-repeat scroll left center transparent;
 }
 a#slnext {
    background: url("/templates/a4joomla-lakeside-free/images/next-white.png") no-repeat scroll right center transparent;
 }
</style>
<script src="/templates/a4joomla-lakeside-free/js/verysimpleslideshow.js" type="text/javascript"></script>
</head>
<body>



<div id="allwrap" class="gainlayout" style="width:1080px;">

<div id="headerwrap" class="gainlayout">
  <div id="header" class="gainlayout">   
      <div id="logo" class="gainlayout">
         	<h2><a href="http://blogdemo.remedios.local/" title="ORACLEBLOG.REMEDIOS.HU">ORACLEBLOG.REMEDIOS.HU</a></h2>
			<h3>Szlogen ha van, ide jön....</h3> 
      </div>
	  <div id="headerright" class="gainlayout">
                <div class="clr"></div>
      </div>
      <div class="clr"></div>
  </div>	  
  <div class="clr"></div>
</div>

<div id="topmenuwrap" class="gainlayout">
           <div id="topmenu" class="gainlayout">
           		<div class="moduletable">
					<h3>Topmenu</h3>
					
<ul class="menu">
<li class="item-101"><a href="/" >Címlap</a></li><li class="item-111"><a href="/index.php/oracle-adatbazis" >Oracle adatbázis</a></li><li class="item-104 current active"><a href="/index.php/oracle-adatbazis-adminisztracio" >Adatbázis adminisztráció</a></li><li class="item-103"><a href="/index.php/oracle-sql" >SQL &amp; PL/SQL</a></li><li class="item-113"><a href="/index.php/sql-plus" >SQL*Plus</a></li><li class="item-114"><a href="/index.php/oracle-12c" >12c újdonságok</a></li></ul>
		</div>
	
           <div class="clr"></div>
         </div> 
            <div id="search" class="gainlayout">
          		<div class="moduletable">
					<form action="/index.php/oracle-adatbazis-adminisztracio" method="post">
	<div class="search">
		<label for="mod-search-searchword">Search...</label><input name="searchword" id="mod-search-searchword" maxlength="20"  class="inputbox" type="text" size="20" value="Search..."  onblur="if (this.value=='') this.value='Search...';" onfocus="if (this.value=='Search...') this.value='';" />	<input type="hidden" name="task" value="search" />
	<input type="hidden" name="option" value="com_search" />
	<input type="hidden" name="Itemid" value="104" />
	</div>
</form>
		</div>
	 
		<div class="clr"></div>  
        </div>
    <div class="clr"></div>
</div> 

<div id="wrap" class="gainlayout">

   

  	  <div id="pathway" class="gainlayout">
        
<div class="breadcrumbs">
<span class="showHere">You are here: </span><a href="/" class="pathway">Home</a> <img src="/templates/a4joomla-lakeside-free/images/system/arrow.png" alt=""  /> <a href="/index.php/oracle-adatbazis-adminisztracio" class="pathway">Adatbázis adminisztráció</a> <img src="/templates/a4joomla-lakeside-free/images/system/arrow.png" alt=""  /> <span>SQL hangolás Plan Management-tel</span></div>

      <div class="clr"></div>
	  </div>
   
  <div id="cbody" class="gainlayout">
    <div id="sidebar" style="width:190px;">     
      		<div class="moduletable">
					<h3>Inspirációk</h3>
					
<ul class="menu">
<li class="item-112"><a href="/index.php/inspiraciok" >Inspirációk</a></li></ul>
		</div>
			<div class="moduletable">
					<h3>Magunkról</h3>
					
<ul class="menu">
<li class="item-108"><a href="/index.php/kik-vagyunk" >Kik vagyunk?</a></li><li class="item-109"><a href="/index.php/miben-tudunk-segiteni" >Miben tudunk segíteni?</a></li></ul>
		</div>
			<div class="moduletable">
					

<div class="custom"  >
	<p><img src="/images/Remedios_logo.JPG" border="0" width="94" height="78" style="border: 0;" /></p></div>
		</div>
	    
  </div>
    <div id="content60" style="width:830px;">    
      <div id="content" class="gainlayout">
	  
<div id="system-message-container">
</div>
      <div class="item-page">

	<h2>
			<a href="/index.php/oracle-adatbazis-adminisztracio/47-sql-hangolas-plan-management-tel">
		SQL hangolás Plan Management-tel</a>
		</h2>





	<dl class="article-info">
	<dt class="article-info-term">Details</dt>
	<dd class="category-name">
				Category: <a href="/index.php/oracle-adatbazis-adminisztracio">Oracle adatbázis adminisztráció</a>		</dd>
	<dd class="published">
	Published on Thursday, 02 October 2014 19:09	</dd>
	<dd class="createdby">
				Written by KoltaiR		</dd>
	</dl>



<p>Gyakran találkozunk azzal a helyzettel, hogy egy dobozos termék SQL utasítását kell hangolni. Az ilyen szituációk egy részében a feltételek adottak a hatékony végrehajtáshoz. A szükséges indexek léteznek és validak, de a CBO ...</p>
 
<p>... valamiért mégsem a hatékony végrehajtási tervet választja. Például azért, mert az utasításban egy hibás hint van megadva. Mit tehet ilyenkor a DBA? Nézzük meg egy példán keresztül!</p>
<pre class="brush:xml">-- sysként létrehozzuk a felhasználót
create user a identified by a;
grant create session to a;
grant create table to a;
alter user a quota unlimited on users;
grant select any dictionary to a;

-- a felhasználónkkal egy teszt táblát létrehozunk
-- indexxel
create table t (n number, v varchar2(100));
insert into t (select object_id, object_name from dba_objects);
create index ti on t (n);
</pre>
<p>Az alkalmazásban van mondjuk egy hibásan, full hint-tel megírt select.</p>
<pre class="brush:sql; highlight: [2]">-- A hibás select
select /*+ full(t) */ * from t where n = 111;


         N V
---------- -------------------------
       111 SYS_IL0000000109C00005$$

-- A végrehajtási terv
select * from table(dbms_xplan.display_cursor());

PLAN_TABLE_OUTPUT
---------------------------------------------------------------------------
SQL_ID  836kam94g7t9j, child number 0
-------------------------------------
select /*+ full(t) */ * from t where n = 111

Plan hash value: 1601196873

--------------------------------------------------------------------------
| Id  | Operation         | Name | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |      |       |       |   137 (100)|          |
|*  1 |  TABLE ACCESS FULL| T    |     1 |    65 |   137   (1)| 00:00:02 |
--------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   1 - filter("N"=111)

-- Elmentjük a végrehajtási tervet mutató lekérdezést
SQL&gt; save plan
Created file plan.sql</pre>
<p> Hozzunk létre egy SQL Plan Baseline-t a hangolandó selecthez. A baseline létrehozásához a példában automatikus baseline capture-t használunk.</p>
<pre class="brush:sql">ALTER SESSION SET optimizer_capture_sql_plan_baselines = TRUE;
-- Az automatikus baseline létrehozásához kétszer kell futtatni az SQL-t
select /*+ full(t) */ * from t where n = 111;
select /*+ full(t) */ * from t where n = 111;
ALTER SESSION SET optimizer_capture_sql_plan_baselines = FALSE;</pre>
<p> Majd ellenőrizzük, hogy létrejött-e a BASELINE</p>
<pre class="brush:sql">-- Létrejött
select signature, sql_handle, sql_text
  2  from dba_sql_plan_baselines;

                 SIGNATURE SQL_HANDLE                     SQL_TEXT
-------------------------- ------------------------------ --------------------------------------------------------------------------------
      13363779336149479779 SQL_b975ae807be53163           select /*+ full(t) */ * from t where n = 111

-- Elmentjük a lekérdezést
SQL&gt; save baseline
Created file baseline.sql</pre>
<p> Nézzük meg, hogy használjuk-e a baseline-t.</p>
<pre class="brush:sql; highlight: [32]">SQL&gt; select /*+ full(t) */ * from t where n = 111;

         N V
---------- -------------------------
       111 SYS_IL0000000109C00005$$

SQL&gt; @plan

PLAN_TABLE_OUTPUT
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  836kam94g7t9j, child number 2
-------------------------------------
select /*+ full(t) */ * from t where n = 111

Plan hash value: 1601196873

--------------------------------------------------------------------------
| Id  | Operation         | Name | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |      |       |       |   137 (100)|          |
|*  1 |  TABLE ACCESS FULL| T    |     1 |    65 |   137   (1)| 00:00:02 |
--------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   1 - filter("N"=111)

Note
-----
   - dynamic sampling used for this statement (level=2)
   - SQL plan baseline SQL_PLAN_bkxdfh1xyacb394ecae5c used for this statement

</pre>
<p> Remek. A baseline-t használjuk, mely egyenlőre a "rossz" végrehajtási tervet tartalmazza. Most futtassuk le az SQL utasítást a javított hinttel. A célunk, hogy a helyes végrehajtási terv bekerüljön a cursor cache-be.</p>
<p> </p>
<pre class="brush:sql; highlight: [24]">-- SQL helyes hinttel
select /*+ index(t) */ * from t where n = 111;

         N V
---------- ----------------------------------------------------------------------------------------------------
       111 SYS_IL0000000109C00005$$

-- Mi a végrehajtási terv?
SQL&gt; @plan

PLAN_TABLE_OUTPUT
---------------------------------------------------------------------------
SQL_ID  4wz48xqvd6mgw, child number 0
-------------------------------------
select /*+ index(t) */ * from t where n = 111

Plan hash value: 3686052240

---------------------------------------------------------------------------
| Id  | Operation                   | Name | Rows  | Bytes | Cost (%CPU)| Time     |
------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT            |      |       |       |     2 (100)|          |
|   1 |  TABLE ACCESS BY INDEX ROWID| T    |     1 |    30 |     2   (0)| 00:00:01 |
|*  2 |   INDEX RANGE SCAN          | TI   |     1 |       |     1   (0)| 00:00:01 |
------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("N"=111)</pre>
<p> Most vegyük fel a baselineba a kívánt, helyes végrehatjtási tervet. Ehhez szükségünk van az</p>
<ul>
<li>SQL handle-re, melyet le tudunk kérdezni a baseline-ből</li>
<li>az SQL-id-ra</li>
<li>és a helyes végrehajtási terv plan hash value értékére</li>
</ul>
<p>Lássunk hozzá!</p>
<pre class="brush:sql; highlight: [14]">-- Elsőre nem sikerült
-- Nincsenek meg a szükséges jogosultságok az "a" felhasználónak
DECLARE
  l_plans_loaded  PLS_INTEGER;
BEGIN
  l_plans_loaded := dbms_spm.load_plans_from_cursor_cache(sql_handle =&gt; 'SQL_b975ae807be53163',
  sql_id =&gt; '4wz48xqvd6mgw',
  plan_hash_value =&gt; '3686052240');
END;
  8  /
DECLARE
*
ERROR at line 1:
ORA-38171: Insufficient privileges for SQL management object operation
ORA-06512: at "SYS.DBMS_SPM", line 2458
ORA-06512: at line 4
</pre>
<p>A baseline-ok adminisztrációjához "administer sql management object" system jogosultság szükséges.</p>
<p>Adjuk meg ezt a jogot "a" felhasználónak és folytassuk a hangolást.</p>
<pre class="brush:sql">-- Megadjuk a jogosultságot
SQL&gt; conn / as sysdba
Connected.
grant administer sql management object to a;

Grant succeeded.

-- Sikeresen betöltjük a helyes végrehajtási tervet
SQL&gt; conn a/a
Connected.
DECLARE
  l_plans_loaded  PLS_INTEGER;
BEGIN
  l_plans_loaded := dbms_spm.load_plans_from_cursor_cache(sql_handle =&gt; 'SQL_b975ae807be53163',
  sql_id =&gt; '4wz48xqvd6mgw',
  plan_hash_value =&gt; '3686052240');
END;

PL/SQL procedure successfully completed.
</pre>
<p> <span style="line-height: 1.3em;">Vizsgáljuk meg ismét a baseline-t. Ellenőrizzük, hogy sikerült-e betölteni az új végrehajtási tervet.</span></p>
<pre class="brush:sql; highlight: [10]">-- Futtassunk egy bővített lekérdezést a dba_sql_plan_baselines-ra
column signature format 99999999999999999999
select signature, sql_handle, plan_name, origin,
accepted, enabled, fixed, reproduced, fetches, sql_text
from dba_sql_plan_baselines;

            SIGNATURE SQL_HANDLE                     PLAN_NAME                      ORIGIN         ACC ENA FIX REP    FETCHES SQL_TEXT
--------------------- ------------------------------ ------------------------------ -------------- --- --- --- --- ---------- --------------------------------------------------------------------------------
 13363779336149479779 SQL_b975ae807be53163           SQL_PLAN_bkxdfh1xyacb394ecae5c AUTO-CAPTURE   YES YES NO  YES          0 select /*+ full(t) */ * from t where n = 111
 13363779336149479779 SQL_b975ae807be53163           SQL_PLAN_bkxdfh1xyacb39685772b MANUAL-LOAD    YES YES NO  YES          2 select /*+ full(t) */ * from t where n = 111

save baselines_details
Created file baselines_details.sql</pre>
<p> A SIGNATURE és az SQL_HANDLE egyedi azonosítója a hangolandó SQL utasításnak. Láthatjuk, hogy az SQL_TEXT és az azonosítók megegyeznek, tehát tudjuk, hogy a két rekord ugyanahhoz az SQL baselinehoz tartozó két végrehajtási tervet reprezentálja. Melyik a helyes terv? Az ORIGIN oszlop tartalma segít. Ahhol az érték "MANUAL-LOAD".</p>
<p>A rossz végrehajtási tervet töröljük tehát.</p>
<p> </p>
<pre class="brush:sql">-- A "rossz" végrehajtási terv törlése
DECLARE
  ret PLS_INTEGER;
BEGIN
  ret := dbms_spm.drop_sql_plan_baseline(sql_handle =&gt; 'SQL_b975ae807be53163',
plan_name =&gt; 'SQL_PLAN_bkxdfh1xyacb394ecae5c');
end;
  7  /

PL/SQL procedure successfully completed.

-- Ellenőrzés
SQL&gt; @baselines_details

            SIGNATURE SQL_HANDLE                     PLAN_NAME                      ORIGIN         ACC ENA FIX REP    FETCHES SQL_TEXT
--------------------- ------------------------------ ------------------------------ -------------- --- --- --- --- ---------- --------------------------------------------------------------------------------
 13363779336149479779 SQL_b975ae807be53163           SQL_PLAN_bkxdfh1xyacb39685772b MANUAL-LOAD    YES YES NO  YES          2 select /*+ full(t) */ * from t where n = 111
</pre>
<p> Valóban csak a helyes végrehajtási terv marad a baseline-ban. Futtassuk tehát a hangolandó SQL-t és nézzük meg, hogy milyen végrehajtási tervet használ.</p>
<pre class="brush:sql; highlight: [35]">-- A selectünk a hibás "full" hint-tel
SQL&gt; select /*+ full(t) */ * from t where n = 111;

         N V
---------- ----------------------------------------------------------------------------------------------------
       111 SYS_IL0000000109C00005$$

-- A végrehajtási terv mégis indexet használ
-- a plan baseline miatt
SQL&gt; @plan

PLAN_TABLE_OUTPUT
------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  836kam94g7t9j, child number 1
-------------------------------------
select /*+ full(t) */ * from t where n = 111

Plan hash value: 3686052240

------------------------------------------------------------------------------------
| Id  | Operation                   | Name | Rows  | Bytes | Cost (%CPU)| Time     |
------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT            |      |       |       |     2 (100)|          |
|   1 |  TABLE ACCESS BY INDEX ROWID| T    |     1 |    30 |     2   (0)| 00:00:01 |
|*  2 |   INDEX RANGE SCAN          | TI   |     1 |       |     1   (0)| 00:00:01 |
------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - access("N"=111)

Note
-----
   - SQL plan baseline SQL_PLAN_bkxdfh1xyacb39685772b used for this statement
</pre>
<p> Sikerült tehát helyes végrehajtási tervet használni egy rosszul hintelt SQL-hez anélkül, hogy az alkalmazás kódját változtattuk volna.</p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
				<ul class="pagenav">
					<li class="pagenav-prev">
						<a href="/index.php/oracle-adatbazis-adminisztracio/48-adatbazis-toerles" rel="prev">&lt; Prev</a>
					</li>
					<li class="pagenav-next">
						<a href="/index.php/oracle-adatbazis-adminisztracio/42-egy-kis-export" rel="next">Next &gt;</a>
					</li>
				</ul>
	
</div>
 
      </div>    
  </div>
    <div class="clr"></div>
  </div>
  
<!--end of wrap-->
</div>
    
<!--end of allwrap-->
</div>
<div id="footerwrap" class="gainlayout" style="width:1080px;"> 
  <div id="footer" class="gainlayout">  
         </div>
  <div id="a4j"><a href="http://a4joomla.com/">Joomla templates by a4joomla</a></div> 
</div>


</body>
</html>
